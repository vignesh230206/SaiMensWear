<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Lineage - Premium Menswear & Order Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for custom aesthetics -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#1a1a1a',
                        'secondary-dark': '#2c2c2c',
                        'accent-gold': '#d4af37', // Subtle gold accent
                        'text-light': '#e5e5e5',
                        'error-red': '#dc2626',
                        'status-processing': '#facc15', // Yellow
                        'status-shipped': '#3b82f6',    // Blue
                        'status-delivered': '#10b981',   // Green
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom styles for the Lookbook aesthetics */
        
        /* General Body Styling for Dark Theme */
        body {
            background-color: #1a1a1a;
            color: #e5e5e5;
            font-family: 'Inter', sans-serif;
        }

        /* Status Card Backgrounds */
        .order-card-status-processing {
            background-color: #3f320f; /* Darker Yellowish background */
            border-left: 4px solid #facc15;
        }
        .order-card-status-shipped {
            background-color: #1a2f4a; /* Darker Bluish background */
            border-left: 4px solid #3b82f6;
        }
        .order-card-status-delivered {
            background-color: #194a3a; /* Darker Greenish background */
            border-left: 4px solid #10b981;
        }

        /* Scroll Reveal Effect Base State */
        .scroll-reveal {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
            will-change: opacity, transform;
        }

        /* Scroll Reveal Active State */
        .scroll-reveal.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables provided by the environment
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Set Firebase Log Level for debugging
        setLogLevel('Debug');

        // --- Core Application Logic ---
        let app, db, auth, userId = null;
        let cart = []; // Local cart state
        let isAuthenticated = false; // Simulate user login status
        let mockUser = {
            email: 'guest@thelineage.com',
            name: 'Guest User',
        };
        let orders = []; // Persistent order state from Firestore

        // Product Data Map for the Modal
        const productData = {
            'linen-shirt': { name: 'The Essential Linen Shirt', price: 129.00, image: 'https://placehold.co/600x600/333/fff?text=The+Linen+Shirt', description: 'Perfectly breathable and lightweight, our linen shirt is tailored for a sharp, modern fit.', },
            'selvedge-denim': { name: 'Raw Japanese Selvedge Denim', price: 245.00, image: 'https://placehold.co/600x600/444/fff?text=Selvedge+Denim', description: 'Crafted from 14oz raw selvedge denim, these jeans feature a classic straight leg cut.', },
            'leather-loafer': { name: 'Italian Suede Loafer', price: 399.00, image: 'https://placehold.co/600x600/555/fff?text=Italian+Leather+Loafer', description: 'Handmade in Florence, these classic leather loafers combine sophisticated style.', },
            'cashmere-turtleneck': { name: 'Scottish Cashmere Turtleneck', price: 195.00, image: 'https://placehold.co/600x600/666/fff?text=Cashmere+Turtleneck', description: 'Luxuriously soft and incredibly warm, our cashmere turtleneck is a winter essential.', },
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DOM Elements ---
            // ... (All original lookbook DOM elements remain)
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const productModal = document.getElementById('product-modal');
            const closeProductModalBtn = document.getElementById('close-product-modal-btn');
            const viewItemButtons = document.querySelectorAll('.view-item-btn');
            const productModalContentContainer = document.getElementById('modal-content-container');
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            const productSizeSelect = document.getElementById('product-size');
            const cartModal = document.getElementById('cart-modal');
            const openCartBtn = document.getElementById('open-cart-btn');
            const closeCartModalBtn = document.getElementById('close-cart-modal-btn');
            const cartModalContentContainer = document.getElementById('cart-modal-content-container');
            const cartItemsList = document.getElementById('cart-items-list');
            const cartTotal = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn');
            const orderConfirmationMsg = document.getElementById('order-confirmation-msg');
            const cartCount = document.getElementById('cart-count');
            const loginModal = document.getElementById('login-modal');
            const signInBtn = document.getElementById('sign-in-btn');
            const closeLoginModalBtn = document.getElementById('close-login-modal-btn');
            const loginForm = document.getElementById('login-form');
            const loginMessage = document.getElementById('login-message');
            const loginView = document.getElementById('login-view');
            const profileView = document.getElementById('profile-view');
            const profileUserName = document.getElementById('profile-user-name');
            const profileUserEmail = document.getElementById('profile-user-email');
            const signOutBtn = document.getElementById('sign-out-btn');
            const loginModalTitle = document.getElementById('login-modal-title');
            const notificationBox = document.getElementById('notification-box');
            // New Orders Modal Elements
            const ordersManagementModal = document.getElementById('orders-management-modal');
            const viewOrdersBtn = document.getElementById('view-orders-btn');
            const closeOrdersModalBtn = document.getElementById('close-orders-modal-btn');
            const ordersListContainer = document.getElementById('orders-list-container');
            
            // --- FIREBASE INITIALIZATION & AUTH ---
            const initFirebase = async () => {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Authenticated user ID:", userId);
                            // Setup Real-time listener for orders once authenticated
                            setupRealtimeOrdersListener();
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                    });
                    
                } catch (error) {
                    console.error("Firebase Initialization or Auth Error:", error);
                    // Handle initialization errors gracefully if needed
                }
            };
            initFirebase();

            // --- UTILITY FUNCTIONS ---
            
            const updateCartCount = () => {
                const totalCount = cart.length; 
                cartCount.textContent = totalCount > 9 ? '9+' : totalCount.toString();
                cartCount.style.display = totalCount > 0 ? 'inline-flex' : 'none';
            };

            const formatPrice = (price) => {
                return `$${price.toFixed(2)}`;
            };

            const showNotification = (message, isError = false) => {
                // ... (Existing showNotification logic)
                notificationBox.textContent = message;
                notificationBox.className = 'fixed bottom-4 right-4 z-[100] p-4 rounded-lg shadow-xl hidden transition-opacity duration-500 opacity-0 notification';
                
                if (isError) {
                    notificationBox.classList.add('bg-error-red/80');
                } else {
                    notificationBox.classList.add('bg-green-700/80');
                }

                notificationBox.classList.remove('hidden');
                setTimeout(() => {
                    notificationBox.classList.remove('opacity-0');
                }, 10);

                setTimeout(() => {
                    notificationBox.classList.add('opacity-0');
                    notificationBox.addEventListener('transitionend', function handler() {
                        notificationBox.classList.add('hidden');
                        notificationBox.removeEventListener('transitionend', handler);
                    }, { once: true });
                }, 3000);
            };

            const showMessage = (text, colorClass) => {
                // Use showNotification for consistency
                showNotification(text, colorClass.includes('red'));
            }

            // --- MODAL CONTROLS ---

            const showModal = (modalElement, contentContainer) => {
                modalElement.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; 
                setTimeout(() => {
                    modalElement.classList.remove('opacity-0');
                    contentContainer.classList.remove('scale-95');
                }, 10);
            };

            const hideModal = (modalElement, contentContainer) => {
                modalElement.classList.add('opacity-0');
                contentContainer.classList.add('scale-95');

                modalElement.addEventListener('transitionend', function handler() {
                    if (modalElement.classList.contains('opacity-0')) {
                        modalElement.classList.add('hidden');
                        document.body.style.overflow = '';
                        modalElement.removeEventListener('transitionend', handler);
                    }
                }, { once: true });
            };

            // --- USER AUTH & PROFILE LOGIC ---

            const updateProfileModal = () => {
                if (isAuthenticated) {
                    loginView.classList.add('hidden');
                    profileView.classList.remove('hidden');
                    loginModalTitle.textContent = 'Account Dashboard';
                    
                    const userName = mockUser.email.substring(0, mockUser.email.indexOf('@')); 
                    profileUserName.textContent = `Welcome, ${userName.charAt(0).toUpperCase() + userName.slice(1)}!`;
                    profileUserEmail.textContent = mockUser.email;

                    signInBtn.innerHTML = '<svg class="w-6 h-6 text-accent-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                } else {
                    loginView.classList.remove('hidden');
                    profileView.classList.add('hidden');
                    loginModalTitle.textContent = 'Customer Sign In';
                    
                    signInBtn.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>';
                }
            };

            const handleLogin = (email) => {
                isAuthenticated = true;
                mockUser.email = email;
                updateProfileModal(); 
                
                const userName = mockUser.email.substring(0, mockUser.email.indexOf('@'));
                showNotification(`Welcome, ${userName.charAt(0).toUpperCase() + userName.slice(1)}! You are now signed in.`, false);
                
                // Keep the modal open in Profile View, as requested previously
                showModal(loginModal, document.getElementById('login-modal-content-container'));
            };

            const handleSignOut = () => {
                isAuthenticated = false;
                mockUser = { email: 'guest@thelineage.com', name: 'Guest User' };

                updateProfileModal();
                showNotification('You have been signed out.', true);
                
                hideModal(loginModal, document.getElementById('login-modal-content-container'));
            };
            
            // --- E-COMMERCE LOGIC ---

            const addToCart = () => {
                // ... (Existing addToCart logic)
                const product = productData[currentProductId];
                const size = productSizeSelect.value;
                
                if (!product || !size) {
                    showNotification('Error: Could not add item to cart.', true);
                    return;
                }
                
                const newItem = {
                    id: currentProductId,
                    name: product.name,
                    price: product.price,
                    size: size,
                    image: product.image,
                };
                cart.push(newItem);

                hideModal(productModal, productModalContentContainer);
                updateCartCount();
                showNotification(`Added ${product.name} (Size: ${size}) to bag.`);
            };

            const updateCartModal = () => {
                // ... (Existing updateCartModal logic)
                cartItemsList.innerHTML = '';
                let total = 0;
                checkoutBtn.classList.remove('hidden');
                orderConfirmationMsg.classList.add('hidden');
                
                if (cart.length === 0) {
                    cartItemsList.innerHTML = '<p class="text-center text-text-light/50 py-4">Your bag is empty.</p>';
                    cartTotal.textContent = formatPrice(0);
                    checkoutBtn.disabled = true;
                    checkoutBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    checkoutBtn.disabled = false;
                    checkoutBtn.classList.remove('opacity-50', 'cursor-not-allowed');

                    cart.forEach((item, index) => {
                        total += item.price;
                        
                        const itemElement = document.createElement('div');
                        itemElement.className = 'flex items-center justify-between p-3 bg-primary-dark rounded-lg shadow-inner';
                        itemElement.innerHTML = `
                            <div class="flex items-center space-x-4">
                                <img src="${item.image}" alt="${item.name}" class="w-12 h-12 object-cover rounded-md">
                                <div>
                                    <p class="font-semibold text-text-light">${item.name}</p>
                                    <p class="text-xs text-text-light/70">Size: ${item.size}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="font-bold text-accent-gold">${formatPrice(item.price)}</span>
                                <button data-index="${index}" class="remove-item-btn text-error-red hover:text-error-red/70 transition duration-200" aria-label="Remove item">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        `;
                        cartItemsList.appendChild(itemElement);
                    });

                    cartTotal.textContent = formatPrice(total);
                }
                
                document.querySelectorAll('.remove-item-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.dataset.index);
                        cart.splice(index, 1);
                        updateCartCount();
                        updateCartModal();
                        showNotification('Item removed from bag.', true);
                    });
                });
            };

            // --- FIREBASE ORDER TRACKING LOGIC ---

            // Utility to generate a simple tracking number
            const generateTrackingId = () => {
                return 'TRK-' + Math.floor(100000 + Math.random() * 900000);
            };
            
            // 1. Place Order (The new checkout handler)
            const placeOrder = async () => {
                if (!userId || cart.length === 0) {
                    showMessage("Cannot place order. Please sign in and add items to your cart.", 'text-red-600');
                    return;
                }

                const ordersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/orders`);
                const total = cart.reduce((sum, item) => sum + item.price, 0);

                try {
                    const newOrder = {
                        // Store complex items array as JSON string for safe storage
                        items: JSON.stringify(cart.map(item => ({ name: item.name, size: item.size, price: item.price }))),
                        totalPrice: total,
                        status: 'Processing', // Initial status
                        trackingId: generateTrackingId(),
                        createdAt: serverTimestamp(),
                        lastUpdated: serverTimestamp(),
                    };

                    await addDoc(ordersCollectionRef, newOrder);
                    
                    // Clear local cart and update UI
                    cart = [];
                    updateCartCount();
                    
                    // Show confirmation message in the cart modal
                    checkoutBtn.classList.add('hidden');
                    orderConfirmationMsg.classList.remove('hidden');
                    orderConfirmationMsg.textContent = `Order placed for ${formatPrice(total)}! Tracking started and viewable in 'Manage Orders'.`;
                    
                    // Automatically close cart and open the orders modal after a delay
                    setTimeout(() => {
                        hideModal(cartModal, cartModalContentContainer);
                        // Optional: showModal(ordersManagementModal, document.getElementById('orders-modal-content-container'));
                    }, 3000);

                } catch (error) {
                    console.error("Error placing order:", error);
                    showMessage("❌ Failed to place order to Firestore.", 'text-red-600');
                }
            };
            
            // 2. Update Order Status (Simulated Tracking Update)
            window.updateOrderStatus = async (docId, currentStatus) => {
                if (!userId || !db) return;

                const nextStatusMap = {
                    'Processing': 'Shipped',
                    'Shipped': 'Delivered',
                    'Delivered': 'Processing' // Cycle back for demo
                };
                const newStatus = nextStatusMap[currentStatus];

                const orderDocRef = doc(db, `artifacts/${appId}/users/${userId}/orders`, docId);
                
                try {
                    await updateDoc(orderDocRef, {
                        status: newStatus,
                        lastUpdated: serverTimestamp()
                    });
                    showMessage(`📦 Tracking updated to ${newStatus}.`, 'text-blue-600');
                } catch (error) {
                    console.error("Error updating order status:", error);
                    showMessage("❌ Failed to update order status.", 'text-red-600');
                }
            };

            // 3. Real-time Listener for Orders
            const setupRealtimeOrdersListener = () => {
                if (!userId || !db) return;
                
                const ordersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/orders`);
                const q = query(ordersCollectionRef);

                onSnapshot(q, (snapshot) => {
                    orders = [];
                    snapshot.forEach((doc) => {
                        orders.push({ id: doc.id, ...doc.data() });
                    });
                    // Sort by creation date (newest first)
                    orders.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                    renderOrders(orders);
                }, (error) => {
                    console.error("Error listening to orders:", error);
                    ordersListContainer.innerHTML = '<p class="text-red-400 p-4">Failed to load orders.</p>';
                });
            };

            // 4. Render Orders to the UI
            const renderOrders = (ordersList) => {
                ordersListContainer.innerHTML = '';
                
                if (ordersList.length === 0) {
                    ordersListContainer.innerHTML = '<p class="text-text-light/50 italic p-4 text-center">No orders found. Purchase an item to begin tracking!</p>';
                    return;
                }

                ordersList.forEach(order => {
                    const date = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleString() : 'N/A';
                    const statusClass = `order-card-status-${order.status.toLowerCase()}`;
                    
                    // Parse the items array back from the JSON string
                    let orderItems;
                    try {
                        orderItems = JSON.parse(order.items || '[]');
                    } catch (e) {
                        orderItems = [];
                    }

                    const firstItemName = orderItems[0] ? `${orderItems[0].name}${orderItems.length > 1 ? ` (+${orderItems.length - 1} more)` : ''}` : 'Multiple Items';

                    const orderHtml = `
                        <div class="p-4 mb-4 rounded-xl shadow-2xl transition duration-300 ${statusClass} flex justify-between items-center flex-wrap">
                            <div class="flex-grow min-w-[200px] mb-3 md:mb-0">
                                <p class="font-bold text-lg text-text-light">${firstItemName}</p>
                                <p class="text-sm text-text-light/70 mt-0.5">Total: <span class="font-semibold text-accent-gold">${formatPrice(order.totalPrice)}</span></p>
                                <p class="text-sm text-text-light/70">Tracking ID: <span class="font-mono">${order.trackingId}</span></p>
                                <p class="text-xs text-text-light/50">Placed: ${date}</p>
                            </div>
                            <div class="flex flex-col items-start md:items-end space-y-2">
                                <span class="px-3 py-1 text-sm font-semibold rounded-full uppercase
                                    ${order.status === 'Processing' ? 'bg-yellow-800/80 text-status-processing' : 
                                       order.status === 'Shipped' ? 'bg-blue-800/80 text-status-shipped' : 
                                       'bg-green-800/80 text-status-delivered'}">
                                    ${order.status}
                                </span>
                                <button onclick="updateOrderStatus('${order.id}', '${order.status}')"
                                    class="bg-accent-gold hover:bg-accent-gold/80 text-primary-dark text-sm font-medium py-1.5 px-3 rounded-full transition duration-150 shadow-lg">
                                    Next Status
                                </button>
                            </div>
                        </div>
                    `;
                    ordersListContainer.insertAdjacentHTML('beforeend', orderHtml);
                });
            };

            // --- EVENT LISTENERS SETUP ---
            
            mobileMenuButton.addEventListener('click', () => { mobileMenu.classList.toggle('hidden'); });

            // Scroll Reveal (omitted for brevity, maintained from original)
            const revealElements = document.querySelectorAll('.scroll-reveal');
            if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const delay = parseFloat(entry.target.dataset.delay) * 1000 || 0;
                            setTimeout(() => {
                                entry.target.classList.add('is-visible');
                                observer.unobserve(entry.target);
                            }, delay);
                        }
                    });
                }, { rootMargin: '0px', threshold: 0.2 });
                revealElements.forEach(el => { observer.observe(el); });
            } else {
                revealElements.forEach(el => el.classList.add('is-visible'));
            }

            document.getElementById('current-year').textContent = new Date().getFullYear();

            // Product Modal Listeners
            let currentProductId = null;
            viewItemButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    currentProductId = event.currentTarget.dataset.productId;
                    const product = productData[currentProductId];
                    if (product) {
                        document.getElementById('modal-name').textContent = product.name;
                        document.getElementById('modal-price').textContent = formatPrice(product.price);
                        document.getElementById('modal-description').textContent = product.description;
                        document.getElementById('modal-image').src = product.image;
                        showModal(productModal, productModalContentContainer);
                    }
                });
            });

            closeProductModalBtn.addEventListener('click', () => hideModal(productModal, productModalContentContainer));
            productModal.addEventListener('click', (event) => { if (event.target === productModal) { hideModal(productModal, productModalContentContainer); } });
            
            // Add to Cart Listener
            addToCartBtn.addEventListener('click', addToCart);

            // Cart Modal Listeners (Open/Close/Checkout)
            openCartBtn.addEventListener('click', () => {
                updateCartModal();
                showModal(cartModal, cartModalContentContainer);
            });
            
            closeCartModalBtn.addEventListener('click', () => hideModal(cartModal, cartModalContentContainer));
            cartModal.addEventListener('click', (event) => { if (event.target === cartModal) { hideModal(cartModal, cartModalContentContainer); } });

            // **NEW Checkout Handler (calls the Firestore logic)**
            checkoutBtn.addEventListener('click', placeOrder);

            // Login Modal Listeners
            signInBtn.addEventListener('click', () => {
                updateProfileModal();
                showModal(loginModal, document.getElementById('login-modal-content-container'));
            });
            
            closeLoginModalBtn.addEventListener('click', () => hideModal(loginModal, document.getElementById('login-modal-content-container')));
            loginModal.addEventListener('click', (event) => { if (event.target === loginModal) { hideModal(loginModal, document.getElementById('login-modal-content-container')); } });
            
            signOutBtn.addEventListener('click', handleSignOut);

            // Orders Management Modal Listeners
            viewOrdersBtn.addEventListener('click', () => {
                hideModal(loginModal, document.getElementById('login-modal-content-container')); // Close login/profile first
                showModal(ordersManagementModal, document.getElementById('orders-modal-content-container'));
            });

            closeOrdersModalBtn.addEventListener('click', () => hideModal(ordersManagementModal, document.getElementById('orders-modal-content-container')));
            ordersManagementModal.addEventListener('click', (event) => { if (event.target === ordersManagementModal) { hideModal(ordersManagementModal, document.getElementById('orders-modal-content-container')); } });


            // Login Form Submission 
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const password = document.getElementById('password').value;
                const email = document.getElementById('email').value;
                
                loginMessage.classList.add('hidden');

                if (email && password.length >= 6) {
                    loginMessage.classList.add('text-green-300');
                    loginMessage.textContent = 'Sign in successful. Displaying profile...';
                    loginMessage.classList.remove('hidden');
                    
                    setTimeout(() => {
                        handleLogin(email);
                        document.getElementById('password').value = '';
                    }, 1000); 
                    
                } else {
                    loginMessage.classList.remove('text-green-300');
                    loginMessage.classList.add('text-error-red');
                    loginMessage.textContent = 'Invalid credentials. Please enter a valid email and a password of at least 6 characters.';
                    loginMessage.classList.remove('hidden');
                }
            });


            // Initial calls
            updateCartCount();
            updateProfileModal();
            
            // Close modals with Escape key
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    if (!productModal.classList.contains('hidden')) { hideModal(productModal, productModalContentContainer); }
                    else if (!cartModal.classList.contains('hidden')) { hideModal(cartModal, cartModalContentContainer); }
                    else if (!loginModal.classList.contains('hidden')) { hideModal(loginModal, document.getElementById('login-modal-content-container')); }
                    else if (!ordersManagementModal.classList.contains('hidden')) { hideModal(ordersManagementModal, document.getElementById('orders-modal-content-container')); }
                }
            });
        });
    </script>

</body>
</html>
    
    <!-- 1. Orders Management Modal (New) -->
    <div id="orders-management-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-primary-dark/80 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-secondary-dark rounded-xl shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300 relative" id="orders-modal-content-container">
            <!-- Close Button -->
            <button id="close-orders-modal-btn" class="absolute top-4 right-4 text-text-light hover:text-accent-gold transition duration-300 p-2 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <h2 class="text-3xl font-bold text-accent-gold mb-6 text-center border-b border-primary-dark pb-3">Order Tracking and History</h2>
            
            <div id="orders-list-container" class="space-y-4">
                <p class="text-text-light/50 italic p-4 text-center">Loading orders...</p>
            </div>
            <p class="text-xs text-text-light/50 mt-6 text-center">All orders are securely stored in the real-time database.</p>
        </div>
    </div>
    
    <!-- 2. Original Lookbook Content Structure -->
    
    <!-- Navigation Bar -->
    <nav class="sticky top-0 z-50 bg-primary-dark bg-opacity-95 shadow-lg backdrop-blur-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <a href="#" class="text-2xl font-bold text-accent-gold tracking-widest uppercase">The Lineage</a>
                
                <!-- Desktop Links -->
                <div class="hidden md:flex space-x-8">
                    <a href="#featured-products" class="text-text-light hover:text-accent-gold transition duration-300 py-2 rounded-md text-sm font-medium">Shop</a>
                    <a href="#collections" class="text-text-light hover:text-accent-gold transition duration-300 py-2 rounded-md text-sm font-medium">Collections</a>
                    <a href="#about-us" class="text-text-light hover:text-accent-gold transition duration-300 py-2 rounded-md text-sm font-medium">Our Story</a>
                    <a href="#contact" class="text-text-light hover:text-accent-gold transition duration-300 py-2 rounded-md text-sm font-medium">Contact</a>
                </div>
                
                <!-- Profile/Cart Icons -->
                <div class="flex items-center space-x-4">
                    <!-- Sign In/Profile Button -->
                    <button id="sign-in-btn" class="text-text-light hover:text-accent-gold p-2 rounded-full transition duration-300 flex items-center" aria-label="Sign In or Profile">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </button>
                    <!-- Cart Button with Count -->
                    <button id="open-cart-btn" class="text-text-light hover:text-accent-gold p-2 rounded-full transition duration-300 relative" aria-label="Shopping Cart">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                        <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-primary-dark transform translate-x-1/2 -translate-y-1/2 bg-accent-gold rounded-full">0</span>
                    </button>
                    <!-- Mobile Menu Button (for responsiveness) -->
                    <button id="mobile-menu-button" class="md:hidden text-text-light hover:text-accent-gold ml-3 p-2 rounded-md transition duration-300" aria-label="Toggle Menu">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu (Hidden by default) -->
        <div id="mobile-menu" class="hidden md:hidden">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="#featured-products" class="block text-text-light hover:bg-secondary-dark px-3 py-2 rounded-md text-base font-medium">Shop</a>
                <a href="#collections" class="block text-text-light hover:bg-secondary-dark px-3 py-2 rounded-md text-base font-medium">Collections</a>
                <a href="#about-us" class="block text-text-light hover:bg-secondary-dark px-3 py-2 rounded-md text-base font-medium">Our Story</a>
                <a href="#contact" class="block text-text-light hover:bg-secondary-dark px-3 py-2 rounded-md text-base font-medium">Contact</a>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="hero-parallax" style="background-image: url('https://placehold.co/1920x800/222/e5e5e5?text=Sophisticated+Menswear'); background-size: cover; background-position: center; background-attachment: fixed; height: 80vh; display: flex; align-items: center; justify-content: center; text-align: center; position: relative;">
        <div class="hero-content bg-primary-dark/30 p-8 rounded-xl backdrop-blur-sm border border-accent-gold/20">
            <h1 class="animated-heading text-5xl sm:text-7xl font-extrabold text-white mb-4 uppercase" style="opacity: 0;">
                Crafted For <span class="text-accent-gold">Excellence</span>
            </h1>
            <p class="animated-subtext text-xl sm:text-2xl text-text-light max-w-xl mx-auto mb-8" style="opacity: 0;">
                The essential staples of a distinguished wardrobe. Timeless design, modern fit.
            </p>
            <a href="#featured-products" class="animated-subtext inline-block px-8 py-3 bg-accent-gold text-primary-dark font-semibold text-lg rounded-full shadow-lg hover:bg-accent-gold/80 transition duration-300 transform hover:scale-105" style="opacity: 0;">
                Discover The Collection
            </a>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">

        <!-- Featured Products Section -->
        <section id="featured-products" class="py-12">
            <h2 class="text-4xl font-bold text-center text-accent-gold mb-12 scroll-reveal" data-delay="0">
                Seasonal Selects
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <!-- Product Cards -->
                <div class="product-card bg-secondary-dark rounded-xl overflow-hidden shadow-2xl border border-secondary-dark hover:border-accent-gold/50 scroll-reveal" data-delay="0.1">
                    <img src="https://placehold.co/600x600/333/fff?text=The+Linen+Shirt" alt="Linen Shirt" class="w-full h-64 object-cover transition duration-500 hover:opacity-80">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold text-text-light mb-2">The Linen Shirt</h3>
                        <p class="text-accent-gold font-bold mb-4">$129</p>
                        <button class="view-item-btn w-full py-2 bg-primary-dark border border-accent-gold text-accent-gold rounded-md hover:bg-accent-gold hover:text-primary-dark transition duration-300" data-product-id="linen-shirt">View Item</button>
                    </div>
                </div>
                <div class="product-card bg-secondary-dark rounded-xl overflow-hidden shadow-2xl border border-secondary-dark hover:border-accent-gold/50 scroll-reveal" data-delay="0.2">
                    <img src="https://placehold.co/600x600/444/fff?text=Selvedge+Denim" alt="Selvedge Denim" class="w-full h-64 object-cover transition duration-500 hover:opacity-80">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold text-text-light mb-2">Selvedge Denim</h3>
                        <p class="text-accent-gold font-bold mb-4">$245</p>
                        <button class="view-item-btn w-full py-2 bg-primary-dark border border-accent-gold text-accent-gold rounded-md hover:bg-accent-gold hover:text-primary-dark transition duration-300" data-product-id="selvedge-denim">View Item</button>
                    </div>
                </div>
                <div class="product-card bg-secondary-dark rounded-xl overflow-hidden shadow-2xl border border-secondary-dark hover:border-accent-gold/50 scroll-reveal" data-delay="0.3">
                    <img src="https://placehold.co/600x600/555/fff?text=Italian+Leather+Loafer" alt="Leather Loafer" class="w-full h-64 object-cover transition duration-500 hover:opacity-80">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold text-text-light mb-2">Leather Loafer</h3>
                        <p class="text-accent-gold font-bold mb-4">$399</p>
                        <button class="view-item-btn w-full py-2 bg-primary-dark border border-accent-gold text-accent-gold rounded-md hover:bg-accent-gold hover:text-primary-dark transition duration-300" data-product-id="leather-loafer">View Item</button>
                    </div>
                </div>
                <div class="product-card bg-secondary-dark rounded-xl overflow-hidden shadow-2xl border border-secondary-dark hover:border-accent-gold/50 scroll-reveal" data-delay="0.4">
                    <img src="https://placehold.co/600x600/666/fff?text=Cashmere+Turtleneck" alt="Cashmere Turtleneck" class="w-full h-64 object-cover transition duration-500 hover:opacity-80">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold text-text-light mb-2">Cashmere Turtleneck</h3>
                        <p class="text-accent-gold font-bold mb-4">$195</p>
                        <button class="view-item-btn w-full py-2 bg-primary-dark border border-accent-gold text-accent-gold rounded-md hover:bg-accent-gold hover:text-primary-dark transition duration-300" data-product-id="cashmere-turtleneck">View Item</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- About Us Section -->
        <section id="about-us" class="py-20 text-center">
            <h2 class="text-4xl font-bold text-accent-gold mb-6 scroll-reveal" data-delay="0">
                Our Philosophy
            </h2>
            <div class="max-w-3xl mx-auto space-y-6 text-lg">
                <p class="scroll-reveal" data-delay="0.1">
                    At The Lineage, we believe true style is found in simplicity and lasting quality. We reject fast fashion in favor of garments meticulously crafted from the world's finest materials. Every stitch, every textile, and every silhouette is chosen to build a wardrobe that stands the test of time.
                </p>
                <p class="scroll-reveal" data-delay="0.3">
                    Our collections are curated for the modern man who values discretion, comfort, and heritage. Experience the difference that premium tailoring and ethical sourcing make. This isn't just clothing; it's an investment in your personal legacy.
                </p>
            </div>
        </section>

        <!-- CTA / Lookbook Section -->
        <section id="collections" class="py-20 flex flex-col md:flex-row items-center bg-secondary-dark rounded-xl shadow-xl p-8 scroll-reveal" data-delay="0.2">
            <div class="md:w-1/2 p-4">
                <h3 class="text-3xl font-bold text-text-light mb-4">Explore the Full Lookbook</h3>
                <p class="text-lg text-text-light/80 mb-6">
                    Dive into our latest seasonal editorials and discover how to style our core pieces. From urban environments to classic gatherings, find your next signature look.
                </p>
                <button class="px-8 py-3 bg-accent-gold text-primary-dark font-semibold text-lg rounded-full shadow-md hover:bg-accent-gold/80 transition duration-300">
                    View Lookbook
                </button>
            </div>
            <div class="md:w-1/2 p-4 mt-8 md:mt-0">
                <img src="https://placehold.co/600x400/111/e5e5e5?text=Seasonal+Lookbook" alt="Lookbook Image" class="w-full h-64 object-cover rounded-lg shadow-2xl transition duration-500 transform hover:scale-[1.01] hover:shadow-accent-gold/20">
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer id="contact" class="bg-primary-dark border-t border-secondary-dark mt-12 py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <div class="text-text-light mb-4">
                &copy; <span id="current-year"></span> The Lineage Menswear. All rights reserved.
            </div>
            <div class="space-x-6 text-sm text-text-light/70">
                <a href="#" class="hover:text-accent-gold transition duration-300">Privacy Policy</a>
                <a href="#" class="hover:text-accent-gold transition duration-300">Terms of Service</a>
                <a href="mailto:info@thelineage.com" class="hover:text-accent-gold transition duration-300">info@thelineage.com</a>
            </div>
        </div>
    </footer>

    <!-- Product Detail Modal -->
    <div id="product-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-primary-dark/80 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-secondary-dark rounded-xl shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300 relative" id="modal-content-container">
            <button id="close-product-modal-btn" class="absolute top-4 right-4 text-text-light hover:text-accent-gold transition duration-300 p-2 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div id="modal-content" class="flex flex-col md:flex-row gap-8 py-8">
                <div class="md:w-1/2">
                    <img id="modal-image" src="" alt="Product Image" class="w-full h-auto object-cover rounded-lg shadow-lg border border-primary-dark">
                </div>
                <div class="md:w-1/2">
                    <h2 id="modal-name" class="text-4xl font-bold text-accent-gold mb-3"></h2>
                    <p id="modal-price" class="text-2xl font-semibold text-text-light mb-6"></p>
                    <p id="modal-description" class="text-text-light/80 mb-6"></p>
                    <div class="space-y-4">
                        <label for="product-size" class="block text-text-light/60 text-sm mb-1">Select Size</label>
                        <select id="product-size" class="w-full bg-primary-dark border border-secondary-dark rounded-md py-2 px-3 text-text-light focus:ring-accent-gold focus:border-accent-gold">
                            <option value="S">S</option>
                            <option value="M" selected>M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                        </select>
                        <button id="add-to-cart-btn" class="w-full py-3 bg-accent-gold text-primary-dark font-semibold text-lg rounded-full shadow-lg hover:bg-accent-gold/80 transition duration-300 transform hover:scale-[1.01]">
                            Add to Cart
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cart / Checkout Modal -->
    <div id="cart-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-primary-dark/80 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-secondary-dark rounded-xl shadow-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300 relative" id="cart-modal-content-container">
            <button id="close-cart-modal-btn" class="absolute top-4 right-4 text-text-light hover:text-accent-gold transition duration-300 p-2 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <h2 class="text-3xl font-bold text-accent-gold mb-6 text-center">Your Shopping Bag</h2>
            
            <div id="cart-items-list" class="space-y-4 border-b border-primary-dark pb-4 mb-4">
                <!-- Cart items will be injected here -->
            </div>

            <div class="flex justify-between items-center text-xl font-semibold mb-6">
                <span>Total:</span>
                <span id="cart-total" class="text-accent-gold">$0.00</span>
            </div>

            <button id="checkout-btn" class="w-full py-3 bg-accent-gold text-primary-dark font-semibold text-lg rounded-full shadow-lg hover:bg-accent-gold/80 transition duration-300 transform hover:scale-[1.01]">
                Proceed to Checkout
            </button>
            <div id="order-confirmation-msg" class="hidden mt-4 p-4 text-center bg-green-900/50 text-green-300 rounded-lg">
                <!-- Confirmation message injected here -->
            </div>
        </div>
    </div>
    
    <!-- Sign In / Profile Modal -->
    <div id="login-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-primary-dark/80 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-secondary-dark rounded-xl shadow-2xl p-8 w-full max-w-md max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300 relative" id="login-modal-content-container">
            <button id="close-login-modal-btn" class="absolute top-4 right-4 text-text-light hover:text-accent-gold transition duration-300 p-2 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <h2 class="text-3xl font-bold text-accent-gold mb-6 text-center" id="login-modal-title">Customer Sign In</h2>

            <!-- Login/Sign Up Form -->
            <div id="login-view">
                <p class="text-center text-text-light/70 mb-8">Sign in or create an account for personalized service.</p>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-text-light">Email Address</label>
                        <input type="email" id="email" class="mt-1 w-full bg-primary-dark border border-secondary-dark rounded-md py-2 px-3 text-text-light focus:ring-accent-gold focus:border-accent-gold" required>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-text-light">Password</label>
                        <input type="password" id="password" class="mt-1 w-full bg-primary-dark border border-secondary-dark rounded-md py-2 px-3 text-text-light focus:ring-accent-gold focus:border-accent-gold" required>
                    </div>
                    
                    <button type="submit" class="w-full py-3 bg-accent-gold text-primary-dark font-semibold text-lg rounded-full shadow-lg hover:bg-accent-gold/80 transition duration-300 transform hover:scale-[1.01] mt-6">
                        Sign In / Create Account
                    </button>
                </form>
                <p id="login-message" class="text-center mt-4 text-error-red hidden"></p>
            </div>
            
            <!-- User Profile View -->
            <div id="profile-view" class="hidden">
                <div class="text-center space-y-4 p-4 bg-primary-dark rounded-lg border border-accent-gold/50 mb-8">
                    <svg class="w-16 h-16 mx-auto text-accent-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>

                    <h3 class="text-2xl font-bold text-text-light" id="profile-user-name">Welcome Back!</h3>
                    <p class="text-sm text-text-light/70">Account Status: <span class="text-green-400 font-semibold">Verified Email</span></p>
                    <p class="text-xl font-mono text-accent-gold break-all" id="profile-user-email">guest@thelineage.com</p>
                </div>

                <div class="space-y-3">
                    <!-- NEW Button to view orders -->
                    <button id="view-orders-btn" class="w-full py-3 bg-primary-dark border border-accent-gold text-accent-gold font-semibold text-lg rounded-full shadow-lg hover:bg-secondary-dark transition duration-300 transform hover:scale-[1.01]">
                        View & Manage Orders
                    </button>
                    <button id="sign-out-btn" class="w-full py-3 bg-error-red text-primary-dark font-semibold text-lg rounded-full shadow-lg hover:bg-error-red/80 transition duration-300 transform hover:scale-[1.01]">
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Box -->
    <div id="notification-box" class="fixed bottom-4 right-4 z-[100] bg-green-700/80 backdrop-blur-sm text-white p-4 rounded-lg shadow-xl hidden transition-opacity duration-500 opacity-0 notification">
        <!-- Notification message injected here -->
    </div>
